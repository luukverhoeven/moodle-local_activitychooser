define(["jquery","core/str","core/modal_factory","core/templates","core/fragment","core/ajax"],function(a,b,c,d,e,f){return{init:function(){var g,h=0,i=70,j=function(b){return console.log("getModuleForm",b),e.loadFragment("local_activitychooser","minimal_form",i,{name:b.name,courseid:b.courseid,section:b.section}).then(function(b,c){var e=a(b);e.find(".collapsible").each(function(b){0!==b&&a(this).hide()}),d.replaceNodeContents(a(".modal-body"),e,c)}.bind(this)).then(function(){a(document).on("keypress",function(b){13===b.which&&a("#mform1").submit()}),Y.use("moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state()})}).fail(Notification.exception)},k=function(a){return f.call([{methodname:"local_activitychooser_toggle_starred",args:{activityid:a}}])[0].then(function(){return l(h)}).then(function(a){return d.render("local_activitychooser/modulechooser",a)}).then(function(a){g.setBody(a)})},l=function(b){var c=document.body.className.match(/course-(\d+)/)[1];return f.call([{methodname:"local_activitychooser_get_activites",args:{sectionnum:b,course:c}}])[0].then(function(b){var c=function(a,b){var c=[],d=[];return a.forEach(function(a){d.length<b?d.push(a):(c.push(d),d=[a])}),d.length>0&&c.push(d),c},d=c(b.all,2),e=c(b.recommended,2),f=c(b.starred,4),g=!!a("#collapsed-all").hasClass("show");return{allRows:d,recommendedRows:e,starredRows:f,allExpandable:e.length||f.length,allExpanded:g}})};b.get_string("addactivity","local_activitychooser").then(function(b){var d='<button class="alternative-modchooser btn link"><i class="icon fa fa-plus fa-fw "></i>'+b+"</button>";a(".section-modchooser-link").parent().append(d);var e=b,f="<div></div>";return c.create({type:c.types.DEFAULT,title:e,body:f,large:!0})}).then(function(b){g=b,a(".alternative-modchooser").click(function(){var c=a(this).closest("li.section").attr("id").split("-")[1];b.show(),h=c,l(c).then(function(a){var c=d.render("local_activitychooser/modulechooser",a);b.setBody(c)})})}),a("body").on("click",".activitychooser-modal-body .row .toggle-favourite",function(){var b=a(this).data("id");a(this).addClass("spinning"),k(b)}),a("body").on("click",".activitychooser-modal-body a.activity_creator",function(b){b.preventDefault(),j({courseid:a(this).data("courseid"),section:a(this).data("section"),name:a(this).data("name")})}),a("body").on("click",".activitychooser-modal-body .row .help-text",function(){a(this).toggleClass("help-visible")})}}});